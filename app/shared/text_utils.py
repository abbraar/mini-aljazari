# app/shared/text_utils.py
from __future__ import annotations

import re
from typing import Dict, List

# Arabic light normalization shared across project
_DIAC = re.compile(r"[\u0617-\u061A\u064B-\u0652\u0670]")


def norm_ar(s: str) -> str:
    if not s:
        return ""
    s = s.strip()
    s = re.sub(_DIAC, "", s)
    s = s.replace("أ", "ا").replace("إ", "ا").replace("آ", "ا")
    s = s.replace("ى", "ي").replace("ئ", "ي").replace("ؤ", "و")
    s = re.sub(r"\s+", " ", s)
    return s


# Theme rules (priority matters; first match wins)
THEME_RULES: Dict[str, List[str]] = {
    "غزل": [
        "حب", "حبيب", "حبيبتي", "حبيبي", "عشق", "غرام", "هوى", "وله", "شوق",
        "اشتقت", "اهواك", "اعشقك", "ود", "وصال", "فراق", "غلا", "عيونك", "عينك",
        "جمال", "خدود", "قبل", "شفايف", "ضحكتك", "خجلك", "سهران", "حنين",
        "لقانا", "وصلك", "هواك", "وصالك", "تغزل", "غزلي", "الهيام", "الولهان"
        "احساسك","احساس",
    ],

    "وطنية": [
        "سعودي", "سعودية", "الوطن", "وطن", "بلاد", "موطني", "راية", "العلم", "الملك",
        "سلمان", "وحدة", "توحد", "بيعة", "دار", "جزيرة", "عبدالعزيز", "عبد العزيز",
        "مجدي", "فخر", "بلادي", "ترابها", "وطننا", "المملكة", "نهضة", "رؤية", "2030",
        "وطن العز", "دارنا", "حكامنا", "العلم الأخضر", "المجد", "رافع", "رايتنا"
    ],

    "رياضية": [
        "نادي", "الاتحاد", "الاتي", "الهلال", "الاهلي", "النصر", "الشباب", "الفيصلي",
        "الاتفاق", "الطائي", "العدالة", "ملعب", "مدرج", "جمهور", "تشجيع", "مباراة",
        "بطولة", "دوري", "كاس", "كأس", "مدرب", "لاعب", "هدف", "ركلة", "شوط", "تسديدة",
        "نهاية المباراة", "فوز", "هزيمة", "تعادل", "حكم", "تبديل", "ميدان", "كرة"
    ],

    "دينية": [
        "الله", "اللهم", "سبحان", "الحمد لله", "استغفر الله", "يارب", "يا رب", "ربي",
        "ربنا", "نبي", "رسول", "محمد", "صلى الله عليه وسلم", "مكة", "المدينة", "المدينه",
        "حج", "عمرة", "دعاء", "ايمان", "توحيد", "مسجد", "قبلة", "قرآن", "سنة", "حديث",
        "صلاة", "الصلاة", "زكاة", "صيام", "رمضان", "الجمعة", "قيام الليل", "جنة", "نار",
        "عذاب", "آخرة", "توبة", "رحمة", "استغفار", "تسبيح", "تهليل", "تكبير", "تحميد"
    ]
}


def tag_theme(text: str) -> str:
    t = norm_ar(text)
    for theme, patterns in THEME_RULES.items():
        for p in patterns:
            if re.search(p, t):
                return theme
    return "اخرى"
